tags: BigQuery
stages:
  Inputs:
    actors:
      Interface:
        parent: Const
        in:
          value:
            const: null
            external: interfaceName
            editor:
              id: com.k2view.interface
              interfaceType:
              - MongoDB
        out:
          value:
            schema: string
      Sql:
        parent: Const
        in:
          value:
            const: null
            external: sql
            schema: string
            editor:
              id: com.k2view.code
              language: sql
        out:
          value:
            schema: string
      Limit:
        parent: JavaScript
        height: 208
        in:
          script:
            const: 'limit > -1 ? limit : 1000;'
          limit:
            const: 1000
            external: limit
            schema: integer
            remark: If the query has no limit, a LIMIT clause will be added with this
              value. In any case, the limit will be enforced on the client side also.
            default: true
            mandatory: false
            editor:
              id: com.k2view.default
              min: 0
              max: 1000
        out:
          result:
            schema: integer
  Add limit if not exists:
    actors:
      AddLimit:
        parent: LuFunction
        in:
          functionName:
            const: bqQueryBuilderAddLimit
          sql:
            link: Sql/value
            schema: any
            mandatory: false
            createdBy: functionName
          limit:
            link: Limit/result
            schema: any
            mandatory: false
            createdBy: functionName
        out:
          result:
            schema: any
  Query:
    actors:
      DbCommand1:
        parent: DbCommand
        in:
          interface:
            const: null
            link: Interface/value
          sql:
            const: null
            link: AddLimit/result
        out:
          result:
            schema: '#ref'
  Limit result:
    remark: Fallback in case user query contains LIMIT
    actors:
      Limit1:
        parent: Limit
        in:
          limit:
            const: null
            link: Limit/result
          values:
            link: DbCommand1/result
        out:
          values:
            external: result
            schema: '#ref'
schemas:
  DbCommand1.out.result:
    type: array
    items:
      type: object
      properties:
        ADDR_ID:
          type: integer
        ADDR_LINE_SEQ_ID:
          type: integer
        DW_EFF_DT:
          type: date
        DW_EXPR_DT:
          type: date
        CURR_IN:
          type: integer
        RCV_IN:
          type: integer
        ADDR_LINE_TX:
          type: string
        DW_LOAD_TS: {
          }
  Limit1.out.values:
    type: array
    items:
      type: object
      properties:
        int_col:
          type: integer
        json_col:
          type: string
